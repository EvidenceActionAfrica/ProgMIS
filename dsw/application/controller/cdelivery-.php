<?phpclass cdelivery extends Controller {    public function index($track = null) {        require 'application/views/_templates/header.php';        $index_model = $this->loadModel('cdeliverymodel');        $programs = $index_model->getPrograms();        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/index.php';        require 'application/views/_templates/footer.php';    }    public function editdelivery($program = null) {        require 'application/views/_templates/header.php';        $program = explode('/', $_GET['url'])[2];        $editdelivery_model = $this->loadModel('cdeliverymodel');        $programdetails = $editdelivery_model->getProgram($program)[0];        $totalwaterpoints = $editdelivery_model->totalWaterpoints($program)[0]['COUNT(id)'];        if (isset($_POST['save-delivery-details'])) {            unset($_POST['save-delivery-details']);            $editdelivery_model->editWaterpoints($_POST);            header('Location:' . URL . 'cdelivery/index');        }        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/editdelivery.php';        require 'application/views/_templates/footer.php';    }    public function waterpoints($program) {        require 'application/views/_templates/header.php';        $waterpoint_model = $this->loadModel('cdeliverymodel');        switch ($_SESSION['country']) {            case 1:                $admin_territory = 'sub_location';                break;            case 2:                $admin_territory = 'parish';                break;            case 3:                $admin_territory = 'health_center';                break;        }        $table = 'odk_chlorine';        $program_array = explode('/', $_GET['url']);        $program = $program_array[2];        if (!isset($_POST['edit-waterpoints']) || !isset($_POST['select_cau'])) {            $waterpoint_details = $waterpoint_model->getWaterpointDetails($admin_territory, $program);        }        $csa = $waterpoint_model->getCsa('staff_list', $filds = array('full_name'), $params = array('position' => '9', 'country' => $_SESSION['country']));        $assigned_csas = $waterpoint_model->getCsa('cdelivery_waterpoints', $filds = array('wp_details_id', 'csa'), $params = null);        $getodkdata = $waterpoint_model->getOdkDataRetrieve('odk_data_chlorine', $program);        $odkData = $waterpoint_model->getOdkData('odk_chlorine', $program);        function return_bytes($val) {            $val = trim($val);            $last = strtolower($val[strlen($val) - 1]);            switch ($last) {                // The 'G' modifier is available since PHP 5.1.0                case 'g':                    $val *= 1024;                case 'm':                    $val *= 1024;                case 'k':                    $val *= 1024;            }            return $val;        }        $post_max_size_M = ini_get('post_max_size');        $post_max_size = return_bytes(ini_get('post_max_size'));        foreach ($assigned_csas as $key => $value) {            $assigned_csas_new[$value['wp_details_id']] = $value;        }        if (isset($_POST['edit-waterpoints']) || isset($_POST['select_cau'])) {            $editable = true;            $cauName = isset($_POST['name']) ? $_POST['name'] : 0;            $waterpoint_details = $waterpoint_model->getWaterpointDetailsCAU($admin_territory, $program, $cauName);            $waterpoint_details_selection = $waterpoint_model->getWaterpointDetails($admin_territory, $program);            $waterpoint_details_select = array();            foreach ($waterpoint_details_selection as $key => $value) {                array_push($waterpoint_details_select, array_splice($value, 3, 1));            }            $array_select = $waterpoint_details_select;        }        if (isset($_POST['save-waterpoints'])) {            print_r($_POST);            foreach ($_POST['id'] as $key => $value) {                $count = $waterpoint_model->getData('cdelivery_waterpoints', $filds = array('id'), $params = array('wp_details_id' => $value));                if ($count > 0) {                    $waterpoint_model->insertTrackingDate($_POST['start_date'][$key], $program);                    $data = array(                        'program' => $program,                        'csa' => $_POST['csa'][$key],                        'jerrycans_per_delivery' => $_POST['actual_jerrycans_per_delivery'][$key],                        'date' => $_POST['start_date'][$key],                        'spot_check' => $_POST['spot_check'][$key],                        'dispenser_problem' => $_POST['dispenser_problem'][$key],                        'problem_recorded' => $_POST['problem_recorded'][$key]                    );                    $waterpoint_model->updateWaterpoints('cdelivery_waterpoints', $data, $params = array('wp_details_id' => $value));                } else {                    $waterpoint_model->insertTrackingDate($_POST['start_date'][$key], $program);                    $data = array(                        'id' => null,                        'country' => $_SESSION['country'],                        'wp_details_id' => $value,                        'program' => $program,                        'csa' => $_POST['csa'][$key],                        'jerrycans_per_delivery' => $_POST['actual_jerrycans_per_delivery'][$key],                        'date' => $_POST['start_date'][$key],                        'spot_check' => $_POST['spot_check'][$key],                        'dispenser_problem' => $_POST['dispenser_problem'][$key],                        'problem_recorded' => $_POST['problem_recorded'][$key]                    );                    $waterpoint_model->addWaterpoints('cdelivery_waterpoints', $data);                }            }            header('Location:' . URL . 'cdelivery/waterpoints/' . $program);        }        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/waterpoints.php';        require 'application/views/_templates/footer.php';    }    private function odkDataCall($spreadsheet_key, $column_to_use, $program) {        $cdeliverymodel = $this->loadModel('cdeliverymodel');        $column_to_use_UPPER = strtoupper($column_to_use);        if (empty($column_to_use)) {            return "404x";        }        $file = 'https://docs.google.com/spreadsheets/d/' . $spreadsheet_key . '/gviz/tq?tqx=out:html&tq';        $file_headers = @get_headers($file);        if (($file_headers[0] == 'HTTP/1.0 404 Not Found') || ($file_headers[0] == 'HTTP/1.1 404 Not Found')) {            return 0;        } else {            if (empty($column_to_use)) {                $html_spreadsheet = file_get_contents('https://docs.google.com/spreadsheets/d/' . $spreadsheet_key . '/gviz/tq?tqx=out:html&tq');            } else {                $html_spreadsheet = file_get_contents('https://docs.google.com/spreadsheets/d/' . $spreadsheet_key . '/gviz/tq?tqx=out:html&tq=select+' . $column_to_use_UPPER . '');            }            $json_google = file_get_contents('https://docs.google.com/spreadsheets/d/' . $spreadsheet_key . '/gviz/tq?tqx=out:json&tq=select+' . $column_to_use_UPPER . '');            $json_google = str_replace("google.visualization.Query.setResponse(", "", "$json_google");            $json_google = str_replace(");", "", "$json_google");            // Convert JSON string to Array            $someArray = json_decode($json_google, true);            if (!isset($someArray['table']['rows'])) {                return 0;            } else {                $numberOfRows = sizeof($someArray['table']['rows']);                if (isset($someArray['table']['rows'][0]['c']['0']['v'])) {                    $cdeliverymodel->deleteProg('odk_data_chlorine', $program);                    for ($i = 0; $i < $numberOfRows; $i++) {                        $data = array(                            "id" => null,                            "country" => $_SESSION['country'], "program" => $program, "waterpoint_id" => $someArray['table']['rows'][$i]['c']['0']['v'],                            "waterpoint_pass" => $someArray['table']['rows'][$i]['c']['0']['v']                        );                        $cdeliverymodel->addData('odk_data_chlorine', $data);                    }                }                return 0;            }        }    }    public function expenditure() {        require 'application/views/_templates/header.php';        $expenditure_model = $this->loadModel('cdeliverymodel');        $expenditure_details = $expenditure_model->getExpenditureDetails();        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/expenditure.php';        require 'application/views/_templates/footer.php';    }    public function editexpenditure($amount, $csa, $date) {        require 'application/views/_templates/header.php';        $editdelivery_model = $this->loadModel('cdeliverymodel');        if (isset($_POST['save'])) {            unset($_POST['save']);            $editdelivery_model->editExpenditureCsa($_POST['amount'], $csa, $date);            header('Location:' . URL . 'cdelivery/expenditure');        }        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/editexpenditure.php';        require 'application/views/_templates/footer.php';    }    public function tracking() {        require 'application/views/_templates/header.php';        $tracking_model = $this->loadModel('cdeliverymodel');        $tracking_details = $tracking_model->getTrackingDetails();        if (isset($_POST['edit-tracking'])) {            $editable = true;        }        if (isset($_POST['save-tracking'])) {            foreach ($_POST['id'] as $key => $value) {                $data = array(                    'kms_covered' => $_POST['kms_covered'][$key],                    'delivery_status' => $_POST['delivery_status'][$key]                );                $tracking_model->updateWaterpoints('cdelivery_tracking', $data, $params = array('id' => $value));            }            header('Location:' . URL . 'cdelivery/tracking');        }        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/tracking.php';        require 'application/views/_templates/footer.php';    }    public function verificationODKAdd($table, $program) {        $cdeliverymodel = $this->loadModel('cdeliverymodel');        $odkArray = array(            "id" => '',            "api_key" => $_POST['apiKey'],            "column_name" => $_POST['column'],            "program" => $program        );        $verificationIdArr = $cdeliverymodel->getOdkData($table, $_POST['program']);        if (sizeof($verificationIdArr) > 0) {            $verificationId = $verificationIdArr[0]['id'];            $cdeliverymodel->deleteData($table, $verificationId);        }        unset($_POST['add-verification-data']);        $cdeliverymodel->addData($table, $odkArray);        $this->odkDataCall($_POST['apiKey'], $_POST['column'], $_POST['program']);        $message = 'ODK Link Added.';        if ($table == 'odk_chlorine') {            header('Location:' . URL . 'cdelivery/waterpoints/' . rawurlencode($_POST['program']) . '/?message=' . urlencode($message));        } else {            header('Location:' . URL . 'cdelivery/index/?message= Fail to upload ODK link');        }    }    public function importTrackingData($program) {        require 'application/views/_templates/header.php';        $model = $this->loadModel('cdeliverymodel');        if (isset($_POST['import-tracking-data'])) {            if (isset($_FILES['tracking-data-csv'])) {                if (empty($_FILES['tracking-data-csv']['error'])) {                    $file = $_FILES['tracking-data-csv']['tmp_name'];                    $csv = array_map('str_getcsv', file($file));                    $model->importTrackingData($csv);                    header('Location:' . URL . 'cdelivery/waterpoints/' . $program . '');                }            }        }        require 'application/views/cdelivery/sidebar.php';        require 'application/views/_templates/footer.php';    }    public function archive() {        require 'application/views/_templates/header.php';        $cdelivery_model = $this->loadModel('cdeliverymodel');        $archive_table_name = $cdelivery_model->getArchiveTable();        if (isset($_POST['save'])) {            unset($_POST['save']);            $data = $cdelivery_model->getArchive($_POST['name']);        }        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/archive.php';        require 'application/views/_templates/footer.php';    }    public function archivetracking($program) {        require 'application/views/_templates/header.php';        $cdelivery_model = $this->loadModel('cdeliverymodel');        if (isset ($_POST['archive'])) {            $message = $cdelivery_model->addArchiveTable($program, $_POST['column']);        }        if ($message == 'error') {            $message = 'You can saved to archive for the same program on a day</br>                delet the previous one for the archive in order to save this one !';        } else {            $message = 'Archive saved';        }        $program = explode('/', $_GET['url'])[2];        header('Location:' . URL . 'cdelivery/waterpoints/' . $program . '?message=' . urlencode($message));        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/archive.php';        require 'application/views/_templates/footer.php';    }    public function truncatearchive($table) {        require 'application/views/_templates/header.php';        $cdelivery_model = $this->loadModel('cdeliverymodel');        $message = $cdelivery_model->deletetablename($table);        if ($message == 'success') {            $message = 'Archive table dropped';        } else {            $message = 'fail to drop';        }        $program = explode('/', $_GET['url'])[2];        header('Location:' . URL . 'cdelivery/archive/?message=' . urlencode($message));        require 'application/views/cdelivery/sidebar.php';        require 'application/views/cdelivery/archive.php';        require 'application/views/_templates/footer.php';    }}?>